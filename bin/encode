#!/usr/bin/env zsh

# SRC=$1
# TITLE=$2
# AUTHOR="Trinity Church"
# YEAR=2011
# COMPOSER="Matt McCullough"
# ALBUM="Minor Prophets"
GENRE=Speech
# COMMENT="In Luke's narrative, the angels' celebration of Jesus's birth hinges on the promise"
# COMMENT="${COMMENT} that his coming means peace on earth. But what did they mean by \"peace?\" And where is it?"

if [[ -z $SRC ]]; then
  echo need src
  exit 1
fi

BUCKET=media.trinitynashville.org

DESTHIFI=${TITLE}-HIFI.mp3
DEST=${TITLE}.mp3
SCALE=${SCALE:-3}
PNG=../resources/static/img/podcast4.png

do_encode () {
  local dest="$2"

  if [[ ! -f $dest ]]; then
    echo encoding $dest
    lame -S --scale $SCALE --preset $1 $SRC $dest
    
    eyeD3 --to-v2.4 $dest
    
    eyeD3 \
     --add-image ${PNG}:ICON \
     -Y ${YEAR} \
     -a "${AUTHOR}" \
     -A "${ALBUM}" \
     -G "${GENRE}" \
     -t "${TITLE}-HIFI" \
     --add-comment "${COMMENT}" \
     --encoding utf8 \
     $dest
    eyeD3 -P itunes-podcast --add $dest
  fi
}

do_encode voice $DEST
do_encode 256 $DESTHIFI 

DURATION=$(eyeD3 $DEST | \
  fgrep Time | awk '{printf $2}' | sed 's/\x1b\[[0-9]*m//g')

if eyeD3 $DEST | fgrep -q TASCAM; then
  echo "FAIL bad id3 encoding...."
  eyeD3 $DEST
  exit 99
fi

cmd="awsg drewr s3api put-object --acl public-read --body $DESTHIFI --bucket $BUCKET --key $DESTHIFI"
echo $cmd
eval ${cmd}

cmd="awsg drewr s3api put-object --acl public-read --body $DEST --bucket $BUCKET --key $DEST"
echo $cmd
eval ${cmd}

echo "Now go set audio/mpeg & x-amz-meta-runtime=$DURATION on the objects"
echo "until https://github.com/aws/aws-cli/issues/356 is fixed"
echo
echo "Publish http://$BUCKET/$DEST on the website"
